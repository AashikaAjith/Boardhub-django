{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load form_tags %}

{% block title %}Post a reply{% endblock %}

{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{% url 'home' %}">Boards</a></li>
  <li class="breadcrumb-item">
    <a href="{% url 'board_topics' topic.board.pk %}">{{ topic.board.name }}</a>
  </li>
  <li class="breadcrumb-item">
    <a href="{% url 'topic_posts' topic.board.pk topic.pk %}">{{ topic.subject }}</a>
  </li>
  <li class="breadcrumb-item active" aria-current="page">Post a reply</li>
{% endblock %}

{% block stylesheet %}
  <!-- EasyMDE CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Reply Form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">Post a reply</h5>
      <form method="post" novalidate>
        {% csrf_token %}

        {% for field in form %}
          <div class="mb-3">
            {{ field.label_tag }}

            {% if field.name == "message" %}
              {% render_field field class="form-control" id="id_message" %}
            {% else %}
              {% render_field field class=field|input_class %}
            {% endif %}

            {% for error in field.errors %}
              <div class="invalid-feedback">{{ error }}</div>
            {% endfor %}

            {% if field.help_text %}
              <div class="form-text">{{ field.help_text|safe }}</div>
            {% endif %}
          </div>
        {% endfor %}

        <button type="submit" class="btn btn-success mt-2">Post Reply</button>
      </form>
    </div>
  </div>

  <!-- Existing Posts -->
  {% for post in topic.posts.all %}
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between">
        <strong>{{ post.created_by.username }}</strong>
        <small class="text-muted">{{ post.created_at|date:"M d, Y H:i" }}</small>
      </div>
      <div class="card-body">
        <p class="card-text">{{ post.get_message_as_markdown|linebreaks }}</p>
      </div>
    </div>
  {% empty %}
    <div class="alert alert-info" role="alert">
      No posts yet. Be the first to reply!
    </div>
  {% endfor %}

</div>
{% endblock %}



{% block javascript %}
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const textarea = document.getElementById("id_message");
      if (!textarea) return;

      const easyMDE = new EasyMDE({
        element: textarea,
        spellChecker: false,
        placeholder: "Write your reply here...",
        status: false
      });

      // Sync markdown content back to hidden textarea before submitting
      const form = textarea.closest("form");
      if (form) {
        form.addEventListener("submit", function () {
          easyMDE.codemirror.save();
          textarea.style.display = "block"; // make it visible just before submit
        });
      }
    });
  </script>
{% endblock %}





